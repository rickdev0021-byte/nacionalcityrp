<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Integrado - NCRP UCP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/custom.css">
    <style>
        .chat-container {
            height: calc(100vh - 180px);
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Start from bottom */
        }
        .message {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.03);
            border-left: 3px solid transparent;
        }
        .message.source-web {
            border-left-color: var(--primary-color);
        }
        .message.source-game {
            border-left-color: var(--success-color, #10b981);
        }
        .message-header {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>

    <div id="navbar-container"></div>

    <div class="container-fluid">
        <div class="row">
            <div id="sidebar-container" class="col-md-3 col-lg-2 p-0"></div>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom border-secondary">
                    <h1 class="h2">Chat Global</h1>
                    <span class="badge bg-success rounded-pill" id="connection-status">Conectado</span>
                </div>

                <div class="card h-100 shadow-sm border-0 bg-dark">
                    <div class="card-body d-flex flex-column p-0">
                        <div id="chat-messages" class="chat-container p-3 custom-scrollbar">
                            <!-- Messages will appear here -->
                            <div class="text-center text-muted mt-5">Conectando ao chat...</div>
                        </div>
                        
                        <div class="p-3 border-top border-secondary bg-surface">
                            <form id="chat-form" class="d-flex gap-2">
                                <input type="text" class="form-control" id="message-input" placeholder="Digite sua mensagem..." autocomplete="off" maxlength="300">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth } from './js/auth.js';
        import { api } from './js/api.js';
        import { renderSidebar, renderNavbar, initTheme } from './js/components.js';
        import { showToast } from './js/app.js';

        initTheme();

        auth.checkAuth();
        document.getElementById('navbar-container').innerHTML = renderNavbar();
        document.getElementById('sidebar-container').innerHTML = renderSidebar('chat');

            // Setup Logout
        setTimeout(() => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    auth.logout();
                });
            }
        }, 100);

        const chatContainer = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const connectionStatus = document.getElementById('connection-status');
        let eventSource = null;

        // Render a message
        function appendMessage(msg) {
            const div = document.createElement('div');
            const sourceClass = msg.source === 'web' ? 'source-web' : 'source-game';
            const sourceLabel = msg.source === 'web' ? 'WEB' : 'JOGO';
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            div.className = `message ${sourceClass}`;
            div.innerHTML = `
                <div class="message-header d-flex justify-content-between">
                    <span>
                        <span class="badge bg-secondary me-2" style="font-size: 0.7em;">${sourceLabel}</span>
                        <strong class="text-white">${msg.player_name}</strong>
                    </span>
                    <small>${time}</small>
                </div>
                <div class="text-light">${msg.message}</div>
            `;
            
            // Because flex-direction is column-reverse, we prepend to show at bottom (visually) 
            // BUT wait, column-reverse puts the first child at the bottom.
            // So if I want new messages at the bottom, I should PREPEND them to the container?
            // No, if column-reverse:
            // [Item 1] (Bottom)
            // [Item 2] (Top)
            // This is confusing. Let's stick to normal column and scroll to bottom.
        }

        // Let's change CSS to normal column
        chatContainer.style.flexDirection = 'column';

        function addMessageToUI(msg) {
            const div = document.createElement('div');
            const sourceClass = msg.source === 'web' ? 'source-web' : 'source-game';
            const sourceLabel = msg.source === 'web' ? 'WEB' : 'JOGO';
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            div.className = `message ${sourceClass}`;
            div.innerHTML = `
                <div class="message-header d-flex justify-content-between">
                    <span>
                        <span class="badge bg-secondary me-2" style="font-size: 0.7em;">${sourceLabel}</span>
                        <strong class="text-white">${msg.player_name}</strong>
                    </span>
                    <small>${time}</small>
                </div>
                <div class="text-light">${escapeHtml(msg.message)}</div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Load History
        async function loadHistory() {
            try {
                const res = await api.get('/chat/history?limit=50');
                if (res.ok && res.data) {
                    chatContainer.innerHTML = '';
                    res.data.forEach(msg => addMessageToUI(msg));
                    scrollToBottom();
                }
            } catch (e) {
                console.error('Failed to load history', e);
            }
        }

        // Connect SSE
        function connectChat() {
            if (eventSource) eventSource.close();
            
            eventSource = new EventSource('/api/chat/stream');
            
            eventSource.onopen = () => {
                connectionStatus.textContent = 'Conectado';
                connectionStatus.className = 'badge bg-success rounded-pill';
            };
            
            eventSource.onerror = () => {
                connectionStatus.textContent = 'Reconectando...';
                connectionStatus.className = 'badge bg-warning rounded-pill';
            };

            eventSource.addEventListener('msg', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    addMessageToUI(data);
                } catch (err) {
                    console.error('Error parsing chat msg', err);
                }
            });
        }

        // Send Message
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;

            messageInput.disabled = true;
            try {
                const res = await api.post('/chat/send', { message: text });
                if (res.ok) {
                    messageInput.value = '';
                    // Message will come back via SSE
                } else {
                    showToast('Erro ao enviar mensagem.', 'danger');
                }
            } catch (err) {
                showToast('Erro de conexÃ£o.', 'danger');
            } finally {
                messageInput.disabled = false;
                messageInput.focus();
            }
        });

        // Init
        loadHistory().then(() => {
            connectChat();
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (eventSource) eventSource.close();
        });
    </script>
</body>
</html>
